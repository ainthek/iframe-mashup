<html>

<head>
    <script src="loadCss.js"></script>
    <script>
    // reading params from IFRAME element
    //TODO: check mobile support of frameElement ?
    // on local chrome and CORS denies access to frameElement ?
    var params = JSON.parse(window.frameElement.getAttribute("params"));

    loadCss(params.css);
    </script>
</head>

<body>
    <h1>w2</h1>
    <script>
    window.parent.postMessage(JSON.stringify({
        "_topic": "ready"
    }), "*");

    window.addEventListener("message", function(evt) {
        document.body.innerHTML += evt.data;
    }, false);

    // API (sync)
    function substract(a, b) {
        var r = a - b;
       
        if (r < 0) { // just for demo
            throw new Error("substract failed");
        }
        return r;
    }
    // exposed API (sync)
    window.addEventListener("message", function(evt) {

        try {
            var request = JSON.parse(evt.data);
        } catch (ex) {
            return;
        }
        if ("substract" === request.method) {

            // perform the real job
            var rpcMessage;
            try {
                var r = substract.apply(null, request.params);
                // send response to caller
                rpcMessage = {
                    result: r,
                    // RPC payload   
                    "jsonrpc": "2.0",
                    "id": request.id // echo original id 
                };
            } catch (ex) {
                //-32603 internal error
                rpcMessage = {
                    error: {
                        code: -32603
                    },
                    // RPC payload   
                    "jsonrpc": "2.0",
                    "id": request.id // echo original id 
                };
            }
            window.parent.postMessage(JSON.stringify(rpcMessage), "*");
            // BUG; posting twice
            window.parent.postMessage(JSON.stringify(rpcMessage), "*");
        }
    }, false);
    </script>
</body>

</html>
