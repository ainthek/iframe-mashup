<!DOCTYPE html>
<html>

<head>
    <script src="loadCss.js"></script>
    <script>
    // reading params from IFRAME element
    //TODO: check mobile support of frameElement ?
    // on local chrome and CORS denies access to frameElement ?
    var params = JSON.parse(window.frameElement.getAttribute("params"));

    loadCss(params.css);
    </script>
</head>

<body>
    <h1>w2</h1>
    <script>
    window.parent.postMessage(JSON.stringify({
        "_topic": "ready"
    }), "*");

    window.addEventListener("message", function(evt) {
        document.body.innerHTML += evt.data;
    }, false);

    // API (example of async function)
    function substract(a, b, callback) {
        setTimeout(function() {
            var r = a - b;
            if (r < 0) {
                callback(new Error("substract failed"));
            } else {
                callback(null, r);
            }
        }, 3000);
    }


    // API (example of sync)
    function add(a, b) {
        var r = a + b;

        if (r < 0) { // just for demo
            throw new Error("substract failed");
        }
        return r;
    }


    window.addEventListener("message", jsonRpcServer({
        // if your function is callback style, just expose it as is
        substract: substract,
        // to expose sync function you must do a little work
        // you must turn sync to async, 
        // use this simple code or some library call used in your widget component
        add: function(a, b, callback) {
            try {
                callback(null, add(a, b));
            } catch (ex) {
                callback(ex);
            }
        }
    }, window.parent, "*"), false);

    function jsonRpcServer(api, targetWindow, targetOrigin) {
        // add own listener listening for all methods from API
        return function(evt) {
            var request;
            try {
                request = JSON.parse(evt.data);
            } catch (ex) {
                return;
                // if no JSON payload, silently return this is probably other message
                // not for my listener, allow iframe to provide JSON RPC along with other messages 
            }


            var method = api[request.method];

            if (!method) {
                targetWindow.postMessage(err(-32601), "*"); //method not found
            } else {
                method.apply(null, request.params.concat(function(e, r) {
                    e //
                        && targetWindow.postMessage(err(-32603), "*") //
                        || targetWindow.postMessage(result(r), "*")
                }));
            }

            //-------------------------------------------------------------------------------------------
            function err(code) {
                return JSON.stringify({
                    error: {
                        code: code
                    },
                    // RPC payload   
                    "jsonrpc": "2.0",
                    "id": request.id // echo original id 
                });
            }

            function result(result) {
                return JSON.stringify({
                    result: result,
                    // RPC payload   
                    "jsonrpc": "2.0",
                    "id": request.id // echo original id 
                });
            }
        }
    }
    </script>
</body>

</html>
