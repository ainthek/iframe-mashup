<!DOCTYPE html>
<html>

<head>
    <script src="loadCss.js"></script>
    <script>
    // reading params from IFRAME element
    //TODO: check mobile support of frameElement ?
    // on local chrome and CORS denies access to frameElement ?
    var params = JSON.parse(window.frameElement.getAttribute("params"));

    loadCss(params.css);
    </script>
</head>

<body>
    <h1>w2</h1>
    <script>
    window.parent.postMessage(JSON.stringify({
        "_topic": "ready"
    }), "*");

    window.addEventListener("message", function(evt) {
        document.body.innerHTML += evt.data;
    }, false);

    // API (example of sync)
    function substract(a, b) {
        var r = a - b;

        if (r < 0) { // just for demo
            throw new Error("substract failed");
        }
        return r;
    }
    // API (example of async function)
    function asyncSubstract(a, b, callback) {
        setTimeout(function() {
            var r = a - b;
            if (r < 0) {
                callback(new Error("substract failed"));
            } else {
                callback(null, r);
            }
        });
    }


    expose({
        // to expose sync function you must do a little work
        // you must turn sync to async, 
        // use this simple code or library if available in your widget imp
        substract: function(a, b, callback) {
            try {
                callback(null, substract(a, b));
            } catch (ex) {
                callback(ex);
            }
        }
    }, window.parent, "*");

    function expose(api, targetWindow, targetOrigin) {
        // add own listener listening for all methods from API
        window.addEventListener("message", function(evt) {
            try {
                var request = JSON.parse(evt.data);
            } catch (ex) {
                // if no JSON payload, silently return this is probably other message
                // not for my listener, allow iframe to provide JSON RPC along with other messages 
                return;
            }
            var rpcMessage;
            if (!api[request.method]) {
                rpcMessage = {
                    error: {
                        code: -32601 //method not found
                    },
                    // RPC payload   
                    "jsonrpc": "2.0",
                    "id": request.id // echo original id 
                };
            } else {
                api[request.method].apply(null, request.params.concat(function(err, r) {
                    if (err) {
                        rpcMessage = {
                            error: {
                                code: -32603 //-32603 internal error
                            },
                            // RPC payload   
                            "jsonrpc": "2.0",
                            "id": request.id // echo original id 
                        };
                    } else {
                        rpcMessage = {
                            result: r,
                            // RPC payload   
                            "jsonrpc": "2.0",
                            "id": request.id // echo original id 
                        };
                    }
                }));
            }
            targetWindow.postMessage(JSON.stringify(rpcMessage), "*");
            // intentional BUG; posting twice
            // targetWindow.postMessage(JSON.stringify(rpcMessage), "*");
        });
    }
    </script>
</body>

</html>
